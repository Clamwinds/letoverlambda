{"version":3,"sources":["download.js"],"names":[],"mappings":"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","file":"download-compiled.js","sourcesContent":["var shallowClone = require('../utils').shallowClone;\nvar stream = require('stream');\nvar util = require('util');\n\nmodule.exports = GridFSBucketReadStream;\n\n/**\n * A readable stream that enables you to read buffers from GridFS.\n *\n * Do not instantiate this class directly. Use `openDownloadStream()` instead.\n *\n * @class\n * @param {Collection} chunks Handle for chunks collection\n * @param {Collection} files Handle for files collection\n * @param {Object} readPreference The read preference to use\n * @param {Object} filter The query to use to find the file document\n * @param {Object} [options=null] Optional settings.\n * @param {Number} [options.sort=null] Optional sort for the file find query\n * @param {Number} [options.skip=null] Optional skip for the file find query\n * @param {Number} [options.start=null] Optional 0-based offset in bytes to start streaming from\n * @param {Number} [options.end=null] Optional 0-based offset in bytes to stop streaming before\n * @fires GridFSBucketReadStream#error\n * @fires GridFSBucketReadStream#file\n * @return {GridFSBucketReadStream} a GridFSBucketReadStream instance.\n */\n\nfunction GridFSBucketReadStream(chunks, files, readPreference, filter, options) {\n  var _this = this;\n  this.s = {\n    bytesRead: 0,\n    chunks: chunks,\n    cursor: null,\n    expected: 0,\n    files: files,\n    filter: filter,\n    init: false,\n    expectedEnd: 0,\n    file: null,\n    options: options,\n    readPreference: readPreference\n  };\n\n  stream.Readable.call(this);\n}\n\nutil.inherits(GridFSBucketReadStream, stream.Readable);\n\n/**\n * An error occurred\n *\n * @event GridFSBucketReadStream#error\n * @type {Error}\n */\n\n/**\n * Fires when the stream loaded the file document corresponding to the\n * provided id.\n *\n * @event GridFSBucketReadStream#file\n * @type {object}\n */\n\n/**\n * Reads from the cursor and pushes to the stream.\n * @method\n */\n\nGridFSBucketReadStream.prototype._read = function() {\n  var _this = this;\n  waitForFile(_this, function() {\n    doRead(_this);\n  });\n};\n\n/**\n * Sets the 0-based offset in bytes to start streaming from. Throws\n * an error if this stream has entered flowing mode\n * (e.g. if you've already called `on('data')`)\n * @method\n * @param {Number} start Offset in bytes to start reading at\n * @return {GridFSBucketReadStream}\n */\n\nGridFSBucketReadStream.prototype.start = function(start) {\n  throwIfInitialized(this);\n  this.s.options.start = start;\n  return this;\n};\n\n/**\n * Sets the 0-based offset in bytes to start streaming from. Throws\n * an error if this stream has entered flowing mode\n * (e.g. if you've already called `on('data')`)\n * @method\n * @param {Number} end Offset in bytes to stop reading at\n * @return {GridFSBucketReadStream}\n */\n\nGridFSBucketReadStream.prototype.end = function(end) {\n  throwIfInitialized(this);\n  this.s.options.end = end;\n  return this;\n};\n\n/**\n * @ignore\n */\n\nfunction throwIfInitialized(self) {\n  if (self.s.init) {\n    throw new Error('You cannot change options after the stream has entered' +\n      'flowing mode!');\n  }\n}\n\n/**\n * @ignore\n */\n\nfunction doRead(_this) {\n  _this.s.cursor.next(function(error, doc) {\n    if (error) {\n      return __handleError(_this, error);\n    }\n    if (!doc) {\n      return _this.push(null);\n    }\n\n    var bytesRemaining = _this.s.file.length - _this.s.bytesRead;\n    var expectedN = _this.s.expected++;\n    var expectedLength = Math.min(_this.s.file.chunkSize,\n      bytesRemaining);\n    if (doc.n > expectedN) {\n      var errmsg = 'ChunkIsMissing: Got unexpected n: ' + doc.n +\n        ', expected: ' + expectedN;\n      return __handleError(_this, new Error(errmsg));\n    }\n    if (doc.n < expectedN) {\n      var errmsg = 'ExtraChunk: Got unexpected n: ' + doc.n +\n        ', expected: ' + expectedN;\n      return __handleError(_this, new Error(errmsg));\n    }\n    if (doc.data.length() !== expectedLength) {\n      if (bytesRemaining <= 0) {\n        var errmsg = 'ExtraChunk: Got unexpected n: ' + doc.n;\n        return __handleError(_this, new Error(errmsg));\n      }\n      var errmsg = 'ChunkIsWrongSize: Got unexpected length: ' +\n        doc.data.length() + ', expected: ' + expectedLength;\n      return __handleError(_this, new Error(errmsg));\n    }\n\n    _this.s.bytesRead += doc.data.length();\n\n    if (doc.data.buffer.length === 0) {\n      return _this.push(null);\n    }\n\n    var sliceStart = null;\n    var sliceEnd = null;\n    var buf = doc.data.buffer;\n    if (_this.s.bytesToSkip != null) {\n      sliceStart = _this.s.bytesToSkip;\n      _this.s.bytesToSkip = 0;\n    }\n\n    if (expectedN === _this.s.expectedEnd && _this.s.bytesToTrim != null) {\n      sliceEnd = _this.s.bytesToTrim;\n    }\n\n    if (sliceStart != null || sliceEnd != null) {\n      buf = buf.slice(sliceStart || 0, sliceEnd || buf.length);\n    }\n\n    _this.push(buf);\n  });\n};\n\n/**\n * @ignore\n */\n\nfunction init(self) {\n  var findOneOptions = {};\n  if (self.s.readPreference) {\n    findOneOptions.readPreference = self.s.readPreference;\n  }\n  if (self.s.options && self.s.options.sort) {\n    findOneOptions.sort = self.s.options.sort;\n  }\n  if (self.s.options && self.s.options.skip) {\n    findOneOptions.skip = self.s.options.skip;\n  }\n\n  self.s.files.findOne(self.s.filter, findOneOptions, function(error, doc) {\n    if (error) {\n      return __handleError(self, error);\n    }\n    if (!doc) {\n      var identifier = self.s.filter._id ?\n        self.s.filter._id.toString() : self.s.filter.filename;\n      var errmsg = 'FileNotFound: file ' + identifier + ' was not found';\n      return __handleError(self, new Error(errmsg));\n    }\n\n    // If document is empty, kill the stream immediately and don't\n    // execute any reads\n    if (doc.length <= 0) {\n      self.push(null);\n      return;\n    }\n\n    self.s.cursor = self.s.chunks.find({ files_id: doc._id }).sort({ n: 1 });\n    if (self.s.readPreference) {\n      self.s.cursor.setReadPreference(self.s.readPreference);\n    }\n\n    self.s.expectedEnd = Math.ceil(doc.length / doc.chunkSize);\n    self.s.file = doc;\n    self.s.bytesToSkip = handleStartOption(self, doc, self.s.cursor,\n      self.s.options);\n    self.s.bytesToTrim = handleEndOption(self, doc, self.s.cursor,\n      self.s.options);\n    self.emit('file', doc);\n  });\n}\n\n/**\n * @ignore\n */\n\nfunction waitForFile(_this, callback) {\n  if (_this.s.file) {\n    return callback();\n  }\n\n  if (!_this.s.init) {\n    init(_this);\n    _this.s.init = true;\n  }\n\n  _this.once('file', function() {\n    callback();\n  });\n};\n\n/**\n * @ignore\n */\n\nfunction handleStartOption(stream, doc, cursor, options) {\n  if (options && options.start != null) {\n    if (options.start > doc.length) {\n      throw new Error('Stream start (' + options.start + ') must not be ' +\n        'more than the length of the file (' + doc.length +')')\n    }\n    if (options.start < 0) {\n      throw new Error('Stream start (' + options.start + ') must not be ' +\n        'negative');\n    }\n    if (options.end != null && options.end < options.start) {\n      throw new Error('Stream start (' + options.start + ') must not be ' +\n        'greater than stream end (' + options.end + ')');\n    }\n\n    cursor.skip(Math.floor(options.start / doc.chunkSize));\n\n    stream.s.bytesRead = Math.floor(options.start / doc.chunkSize) *\n      doc.chunkSize;\n    stream.s.expected = Math.floor(options.start / doc.chunkSize);\n\n    return options.start - stream.s.bytesRead;\n  }\n}\n\n/**\n * @ignore\n */\n\nfunction handleEndOption(stream, doc, cursor, options) {\n  if (options && options.end != null) {\n    if (options.end > doc.length) {\n      throw new Error('Stream end (' + options.end + ') must not be ' +\n        'more than the length of the file (' + doc.length +')')\n    }\n    if (options.start < 0) {\n      throw new Error('Stream end (' + options.end + ') must not be ' +\n        'negative');\n    }\n\n    var start = options.start != null ?\n      Math.floor(options.start / doc.chunkSize) :\n      0;\n\n    cursor.limit(Math.ceil(options.end / doc.chunkSize) - start);\n\n    stream.s.expectedEnd = Math.ceil(options.end / doc.chunkSize);\n\n    return (Math.ceil(options.end / doc.chunkSize) * doc.chunkSize) -\n      options.end;\n  }\n}\n\n/**\n * @ignore\n */\n\nfunction __handleError(_this, error) {\n  _this.emit('error', error);\n}\n"]}