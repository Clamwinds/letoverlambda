{"version":3,"sources":["utils.js"],"names":[],"mappings":"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","file":"utils-compiled.js","sourcesContent":["/*!\n * mongoskin - utils.js\n * \n * Copyright(c) 2011 - 2012 kissjs.org\n * Copyright(c) 2012 fengmk2 <fengmk2@gmail.com>\n * MIT Licensed\n */\n\n\"use strict\";\n\n/**\n * Module dependencies.\n */\n\nvar __slice = Array.prototype.slice;\nvar EventEmitter = require('events').EventEmitter;\nvar constant = require('./constant');\nvar STATE_CLOSE = constant.STATE_CLOSE;\nvar STATE_OPENNING = constant.STATE_OPENNING;\nvar STATE_OPEN = constant.STATE_OPEN;\n\nexports.makeSkinClass = function makeSkinClass(NativeClass, useNativeConstructor, isSingle) {\n\n  function onError (err, args, name) {\n    var cb = args.pop();\n    if (cb && typeof cb === 'function') {\n      cb(err);\n    } else {\n      console.error(\"Error occured with no callback to handle it while calling \" + name,  err);\n    }\n  };\n\n  var skinClassName = 'Skin' + NativeClass.name;\n  function SkinClass() {\n    var args = __slice.call(arguments);\n    this._construct_args = args;\n    if(useNativeConstructor && arguments.length > 0) {\n      args.unshift(null);\n      var ctor = NativeClass.bind.apply(NativeClass, args);\n      this._native = new ctor();\n    } else {\n      this._native = null;\n    }\n    this._emitter = new EventEmitter();\n    this._emitter.setMaxListeners(50);\n    this._state = STATE_CLOSE;\n    this._init && this._init();\n    if(isSingle) {\n      for(var propName in SkinClass.prototype) {\n        if(propName[0] != '_') {\n          this[propName] = SkinClass.prototype[propName];\n        }\n      }\n      var res = NativeClass.apply(this, args);\n      for(propName in res) {\n        this[propName] = res[propName];\n        if(propName[0] != '_') bindObject(this, propName);\n      }\n    }\n  }\n  SkinClass._class_name = skinClassName;\n\n  function bindObject(target, propName) {\n    if(target.hasOwnProperty(propName) && typeof target[propName] == 'function') {\n      var fn = target[propName];\n      target[propName] = function() {\n        var args = __slice.apply(arguments);\n        if (target._state == STATE_OPEN) {\n          this._native[propName].apply(this._native, args);\n        } else {\n          this.open(function(err, p_native) {\n              if (err) {\n                onError(err, args, skinClassName + '.' + propName);\n              } else {\n                p_native[propName].apply(p_native, args);\n              }\n          });\n        }\n        return this;\n      }.bind(target);\n    }\n  }\n\n  function bindSkin(propName) {\n    var fn;\n    var desc = Object.getOwnPropertyDescriptor(NativeClass.prototype, propName);\n    if(!desc) {\n      // console.log('no desc', skinClassName, propName, desc);\n      try{\n        fn = NativeClass.prototype[propName];\n      } catch(e) {}\n    } else {\n      fn = desc.value;\n    }\n    if(typeof fn == 'function') {\n      SkinClass._bindMethod(propName);\n    } else if(desc) {\n      if (desc.get) {\n        SkinClass._bindGetter(propName);\n      }\n      if (desc.set) {\n        SkinClass._bindSetter(propName);\n      }\n    // } else {\n    //   this will never be called, so comment it.\n    //   console.log('no desc and no value', skinClassName, propName);\n    }\n  }\n\n  SkinClass._bindMethod = function(propName) {\n    SkinClass.prototype[propName] = function() {\n      var args = __slice.apply(arguments);\n      if (this._state == STATE_OPEN) {\n        this._native[propName].apply(this._native, args);\n      } else {\n        this.open(function(err, p_native) {\n            if (err) {\n              onError(err, args, skinClassName + '.' + propName);\n            } else {\n              p_native[propName].apply(p_native, args);\n            }\n        });\n      }\n      return this;\n    }\n  }\n\n  SkinClass._bindGetter = function(propName) {\n      SkinClass.prototype.__defineGetter__(propName, function() {\n          return this._native && this._native[propName];// || this['_prop_' + propName];\n      });\n  }\n\n  SkinClass._bindSetter = function(propName) {\n      SkinClass.prototype.__defineSetter__(propName, function(value) {\n          // this['_prop_' + propName] = value;\n          this.open(function(err, p_native) {\n              if(err) return onError(err, args, skinClassName + '.' + propName);\n              p_native[propName] = value;\n          });\n      });\n  }\n\n  if(!isSingle) {\n    for(var propName in NativeClass.prototype) {\n      if(propName[0] != '_') bindSkin(propName);\n    }\n  }\n\n  SkinClass.prototype.open = function(callback) {\n    switch (this._state) {\n      case STATE_OPEN:\n        callback(null, this._native);\n        break;\n      case STATE_OPENNING:\n        this._emitter.once('open', callback);\n        break;\n      default:\n        this._emitter.once('open', callback);\n        this._state = STATE_OPENNING;\n        var self = this;\n        this._open(function(err, p_native) {\n            if (err) {\n              self._state = STATE_CLOSE;\n            } else {\n              self._state = STATE_OPEN;\n              self._native = p_native;\n            }\n            self._emitter.emit('open', err, p_native);\n        });\n    }\n    return this;\n  }\n\n  SkinClass.prototype.close = function (callback) {\n    if (this._state === STATE_CLOSE) {\n      callback && callback();\n    } else if (this._state === STATE_OPEN) {\n      this._state = STATE_CLOSE;\n      this._close(callback);\n    } else if (this._state === STATE_OPENNING) {\n      var self = this;\n      this._emitter.once('open', function (err, db) {\n          self.close(callback);\n      });\n    }\n    this._native = null;\n    return this;\n  }\n\n  SkinClass.prototype._close = function(callback) {\n    if(this._native.close) {\n      this._native.close(callback)\n    } else if(callback) {\n      callback();\n    }\n  }\n\n  SkinClass.prototype.isOpen = function() {\n    return this._state === STATE_OPEN;\n  }\n\n  return SkinClass;\n\n}\n"]}