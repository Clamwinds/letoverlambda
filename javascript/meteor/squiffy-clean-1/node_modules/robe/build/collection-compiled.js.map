{"version":3,"sources":["collection.js"],"names":[],"mappings":"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","file":"collection-compiled.js","sourcesContent":["\"use strict\";\n\n\nvar _prototypeProperties = function (child, staticProps, instanceProps) { if (staticProps) Object.defineProperties(child, staticProps); if (instanceProps) Object.defineProperties(child.prototype, instanceProps); };\n\nvar _classCallCheck = function (instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } };\n\nvar _ = require(\"lodash\"),\n    compose = require(\"generator-compose\"),\n    Class = require(\"class-extend\"),\n    Q = require(\"bluebird\"),\n    schemaBuilder = require(\"simple-mongo-schema\");\n\n\nvar Cursor = require(\"./cursor\"),\n    Document = require(\"./document\"),\n    RobeUtils = require(\"./utils\");\n\n\n\n/**\n * Represents a collection in the database.\n */\nvar Collection = (function () {\n  /**\n   * Constructor.\n   *\n   * @param  {Object} db Underlying database connection.\n   * @param  {Object} collection The underlying collection.\n   * @param  {Object} options Additional options.\n   * @param  {Object} [options.schema] Database schema.\n   * @param  {Array} [options.indexes] Database indexex to setup.\n   * @param  {Boolean} [options.rawMode] Whether to enable raw query mode by default. Default if false.\n   * @param  {Object} [options.methods] Convenience methods to make available on this collection instance. Each method is specified as a `name`:`function *` pair.\n   * @param  {Object} [options.docMethods] Convenience methods to make available on this collection's `Document` instances. Each method is specified as a `name`:`function *` pair.\n   */\n  function Collection(db, collection) {\n    var options = arguments[2] === undefined ? {} : arguments[2];\n    _classCallCheck(this, Collection);\n\n    this.db = db;\n\n    this.options = _.defaults(options, {\n      schema: {},\n      rawMode: false,\n      docMethods: {} });\n\n    this.schema = schemaBuilder(options.schema);\n    this.indexes = options.indexes || [];\n\n    this.collection = collection;\n\n    Object.defineProperty(this, \"_hooks\", {\n      value: {\n        before: {\n          insert: [],\n          update: [],\n          remove: [] },\n        after: {\n          insert: [],\n          update: [],\n          remove: [] }\n      },\n      enumerable: false\n    });\n\n    // methods\n    for (var _name in options.methods || {}) {\n      var method = options.methods[_name];\n\n      if (RobeUtils.isGen(method)) {\n        this[_name] = RobeUtils.bindGen(method, this);\n      } else {\n        this[_name] = _.bind(method, this);\n      }\n    }\n  }\n\n  _prototypeProperties(Collection, null, {\n    ensureIndexes: {\n\n\n      /**\n       * Ensure all configured indexes exist in the database.\n       *\n       * This looks through the indexes supplied during construction and sets them \n       * up.\n       */\n      value: function* ensureIndexes() {\n        var self = this;\n\n        yield Q.map(this.indexes, function (idx) {\n          return self.collection.ensureIndex(idx.fields, idx.options || {});\n        });\n      },\n      writable: true,\n      configurable: true\n    },\n    before: {\n\n\n      /**\n       * Execute given handler before given event\n       *\n       * @param {String} eventName Name of event. One of `insert`, `remove`, `update`\n       * @param {Function} genFn Generator function which takes a callback as a parameter.\n       */\n      value: function before(eventName, genFn) {\n        this._hooks.before[eventName].push(genFn);\n      },\n      writable: true,\n      configurable: true\n    },\n    after: {\n\n      /**\n       * Execute given handler after given event\n       *\n       * @param {String} eventName Name of event. One of `insert`, `remove`, `update`\n       * @param {Function} genFn Generator function which takes a callback as a parameter.\n       */\n      value: function after(eventName, genFn) {\n        this._hooks.after[eventName].push(genFn);\n      },\n      writable: true,\n      configurable: true\n    },\n    _runHook: {\n\n\n\n      /**\n       * Execute given hook\n       * @param  {String} when Hook type.\n       * @param  {String} eventName Hook event.\n       * @param  {Array} [args] Parameters to pass to hook.\n       *\n       * @private\n       */\n      value: function* _runHook(when, eventName) {\n        for (var _len = arguments.length, args = Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n          args[_key - 2] = arguments[_key];\n        }\n\n        var fn = compose(this._hooks[when][eventName]);\n\n        yield fn.apply(this, args);\n      },\n      writable: true,\n      configurable: true\n    },\n    insert: {\n\n\n      /**\n       * Insert a document.\n       * \n       * @param  {Object} attrs The document attributes.\n       * @param {Object} [options] Additional options.\n       * @param {Boolean} [options.rawMode] Whether to return the resulting raw document as-is. Overrides the default for the collection.\n       * @return {Document} the newly inserted document.\n       */\n      value: function* insert(attrs, options) {\n        yield this._runHook(\"before\", \"insert\", attrs);\n\n        // validate against schema\n        yield this.schema.validate(attrs);\n\n        var res = yield this.collection.insert(attrs);\n\n        yield this._runHook(\"after\", \"insert\", res);\n\n        return this._createDocumentFromQueryResult(res, options);\n      },\n      writable: true,\n      configurable: true\n    },\n    update: {\n\n\n      /**\n       * Update documents.\n       * \n       * @param {Object} [search] Filtering query.\n       * @param  {Object} update The update to make.\n       */\n      value: function* update(_x, update) {\n        var search = arguments[0] === undefined ? {} : arguments[0];\n        yield this._runHook(\"before\", \"update\", search, update);\n\n        // validate against schema\n        if (update.$set) {\n          yield this.schema.validate(update.$set, {\n            ignoreMissing: true\n          });\n        } else {\n          yield this.schema.validate(update, {\n            ignoreMissing: false\n          });\n        }\n\n        var ret = yield this.collection.update(search, update);\n\n        yield this._runHook(\"after\", \"update\", search, update, ret);\n\n        return ret;\n      },\n      writable: true,\n      configurable: true\n    },\n    remove: {\n\n\n      /**\n       * Remove documents.\n       * \n       * @param {Object} [search] Filtering query.\n       */\n      value: function* remove(search) {\n        yield this._runHook(\"before\", \"remove\", search);\n\n        var ret = yield this.collection.remove(search);\n\n        yield this._runHook(\"after\", \"remove\", search, ret);\n\n        return ret;\n      },\n      writable: true,\n      configurable: true\n    },\n    find: {\n\n\n      /**\n       * Find documents from this collection.\n       *\n       * @param {Object} [selector] Filtering query.\n       * @param {Object} [options] Query options.\n       * @param {Object} [options.sort] Sort filter (Mongo syntax).\n       * @param {Number} [options.skip] Number of records to skip at the beginning.\n       * @param {Number} [options.limit] Max. no of records to return.\n       * @param {Object} [options.fields] Fields to return or exclude (Mongo syntax).\n       * @param {Boolean} [options.rawMode] Whether to return the resulting raw document as-is. Overrides the default for the collection.\n       *\n       * @return {Array} Results\n       */\n      value: function* find() {\n        var selector = arguments[0] === undefined ? {} : arguments[0];\n        var options = arguments[1] === undefined ? {} : arguments[1];\n        var self = this;\n\n        var res = yield this.collection.find(selector, _.extend({}, options));\n\n        return res.map(function (v) {\n          return self._createDocumentFromQueryResult(v, options);\n        });\n      },\n      writable: true,\n      configurable: true\n    },\n    count: {\n\n\n\n      /**\n       * Count documents in this collection.\n       *\n       * @param {Object} [selector] Filtering query.\n       *\n       * @return {Array} Results\n       */\n      value: function* count() {\n        var selector = arguments[0] === undefined ? {} : arguments[0];\n        return yield this.collection.count(selector);\n      },\n      writable: true,\n      configurable: true\n    },\n    findOne: {\n\n\n\n      /**\n       * Find a single document from this collection.\n       *\n       * @param {String|Object} selector ObjectId or filtering query.\n       * @param {Object} [options] Query options.\n       * @param {Object} [options.sort] Sort filter (Mongo syntax).\n       * @param {Number} [options.skip] Number of records to skip at the beginning.\n       * @param {Object} [options.fields] Fields to return or exclude (Mongo syntax).\n       */\n      value: function* findOne(selector) {\n        var options = arguments[1] === undefined ? {} : arguments[1];\n        var self = this;\n\n        options.limit = 1;\n\n        var results = yield this.collection.find(selector, options);\n\n        return results.length ? this._createDocumentFromQueryResult(results.pop(), options) : null;\n      },\n      writable: true,\n      configurable: true\n    },\n    findStream: {\n\n\n\n\n      /**\n       * Stream documents from this collection.\n       *\n       * @param {Object} [selector] Filtering query.\n       * @param {Object} [options] Query options.\n       * @param {Object} [options.sort] Sort filter (Mongo syntax).\n       * @param {Number} [options.skip] Number of records to skip at the beginning.\n       * @param {Number} [options.limit] Max. no of records to return.\n       * @param {Object} [options.fields] Fields to return or exclude (Mongo syntax).\n       * @param {Boolean} [options.rawMode] Whether to return the resulting raw document as-is. Overrides the default for the collection.\n       *\n       * @return {Cursor} cursor object\n       */\n      value: function* findStream() {\n        var selector = arguments[0] === undefined ? {} : arguments[0];\n        var options = arguments[1] === undefined ? {} : arguments[1];\n        _.extend(options, {\n          stream: true,\n          timeout: false });\n\n        return new Cursor(this, this.collection.find(selector, options), options);\n      },\n      writable: true,\n      configurable: true\n    },\n    addWatcher: {\n\n\n      /**\n       * Add watcher to this collection's oplog tailing cursor.\n       *\n       * The Mongo oplog will be observed for changes to this collection. If \n       * something happens the callback will be invoked.\n       *\n       * @param {Function} callback Callback to add to observers list.\n       * @see Robe.Oplog\n       */\n      value: function* addWatcher(callback) {\n        (yield this.db.oplog()).on(this.collection.name + \":*\", callback);\n      },\n      writable: true,\n      configurable: true\n    },\n    removeWatcher: {\n\n\n\n      /**\n       * Remove watcher from this collection's oplog tailing cursor.\n       *\n       * @param {Function} callback Callback to remove from the observers list.\n       */\n      value: function* removeWatcher(callback) {\n        (yield this.db.oplog()).off(this.collection.name + \":*\", callback);\n      },\n      writable: true,\n      configurable: true\n    },\n    _createDocument: {\n\n\n\n      /**\n       * Create Mongo document from given raw object.\n       *\n       * @param {Object} mongoDoc Mongo document returned as a query result.\n       * \n       * @return {Document|Object}\n       *\n       * @private\n       */\n      value: function _createDocument(mongoDoc) {\n        var d = new Document(this, mongoDoc);\n\n        for (var key in this.options.docMethods) {\n          var method = this.options.docMethods[key];\n\n          if (RobeUtils.isGen(method)) {\n            d[key] = RobeUtils.bindGen(method, d);\n          } else {\n            d[key] = _.bind(method, d);\n          }\n        }\n\n        return d;\n      },\n      writable: true,\n      configurable: true\n    },\n    _createDocumentFromQueryResult: {\n\n\n\n      /**\n       * Create Mongo document from given raw object returned by query.\n       *\n       * @param {Object} mongoDoc Mongo document returned as a query result.\n       * @param {Object} [options] Additional options.\n       * @param {Boolean} [options.rawMode] Whether to return the resulting raw document as-is. Overrides the default for the collection.\n       * \n       * @return {Document|Object}\n       *\n       * @private\n       */\n      value: function _createDocumentFromQueryResult(mongoDoc) {\n        var options = arguments[1] === undefined ? {} : arguments[1];\n        if (options.rawMode || this.options.rawMode) {\n          return mongoDoc;\n        } else {\n          return this._createDocument(mongoDoc);\n        }\n      },\n      writable: true,\n      configurable: true\n    }\n  });\n\n  return Collection;\n})();\n\n\n\n\nCollection.extend = Class.extend;\n\nmodule.exports = Collection;"]}