{"version":3,"sources":["document.js"],"names":[],"mappings":"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","file":"document-compiled.js","sourcesContent":["\"use strict\";\n\n\nvar _prototypeProperties = function (child, staticProps, instanceProps) { if (staticProps) Object.defineProperties(child, staticProps); if (instanceProps) Object.defineProperties(child.prototype, instanceProps); };\n\nvar _classCallCheck = function (instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } };\n\nvar _ = require(\"lodash\"),\n    Class = require(\"class-extend\"),\n    Q = require(\"bluebird\");\n\n\n\n/**\n * Represents a document within a collection.\n */\nvar Document = (function () {\n  /**\n   * Constructor.\n   *\n   * @param  {Collection} collection The underlying collection.\n   * @param  {Object} [doc] The Mongo record document.\n   */\n  function Document(collection) {\n    var doc = arguments[1] === undefined ? {} : arguments[1];\n    _classCallCheck(this, Document);\n\n    var self = this;\n\n    Object.defineProperties(this, {\n      __col: {\n        enumerable: false,\n        writable: false,\n        value: collection\n      },\n      __newDoc: {\n        enumerable: false,\n        writable: true,\n        value: {}\n      },\n      __marked: {\n        enumerable: false,\n        writable: true,\n        value: {}\n      },\n      // can store any extra data that's not intended for persistence in this field\n      __extra: {\n        enumerable: false,\n        writable: true,\n        value: {}\n      } });\n\n    this._resetProperties(doc);\n  }\n\n  _prototypeProperties(Document, null, {\n    _resetProperties: {\n\n      /**\n       * Reset original properties to given doc.\n       * @private\n       */\n      value: function _resetProperties(doc) {\n        var self = this;\n\n        Object.defineProperty(self, \"__doc\", {\n          enumerable: false,\n          writable: true,\n          value: doc\n        });\n\n        self.__newDoc = {};\n        self.__marked = {};\n\n        for (var key in self.__doc) {\n          (function (key) {\n            // if property not yet defined\n            if (!Object.getOwnPropertyDescriptor(self, key)) {\n              // ...then define it!\n              Object.defineProperty(self, key, {\n                enumerable: true,\n                configurable: true,\n                get: function () {\n                  return _.has(self.__newDoc, key) ? self.__newDoc[key] : self.__doc[key];\n                },\n                set: function (val) {\n                  self.__newDoc[key] = val;\n                }\n              });\n            }\n          })(key);\n        }\n\n        // delete any extraneous properties\n        Object.keys(this).forEach(function (key) {\n          if (!_.isFunction(self[key]) && !self.__doc.hasOwnProperty(key)) {\n            delete self[key];\n          }\n        });\n      },\n      writable: true,\n      configurable: true\n    },\n    markChanged: {\n\n\n      /**\n       * Mark a property as having changed.\n       *\n       * This is useful if you a change a value within a non-scalar (e.g. `object`) \n       * property or an array.\n       * \n       * @param  {Array} ...keys Properties to mark as having changed.\n       * @return {[type]}     [description]\n       */\n      value: function markChanged() {\n        for (var _len = arguments.length, keys = Array(_len), _key = 0; _key < _len; _key++) {\n          keys[_key] = arguments[_key];\n        }\n\n        for (var k in keys) {\n          this.__marked[keys[k]] = true;\n        }\n      },\n      writable: true,\n      configurable: true\n    },\n    toJSON: {\n      value: function toJSON() {\n        var self = this;\n\n        var ret = {};\n\n        Object.keys(this).forEach(function (key) {\n          if (!_.isFunction(self[key])) {\n            ret[key] = self[key];\n          }\n        });\n\n        return ret;\n      },\n      writable: true,\n      configurable: true\n    },\n    changes: {\n\n\n      /**\n       * Get changed properties.\n       * @return {Object}\n       */\n      value: function changes() {\n        var self = this;\n\n        var ret = {};\n\n        Object.keys(this).forEach(function (key) {\n          if (!_.isFunction(self[key])) {\n            if (self.__doc[key] !== self[key] || self.__marked[key]) {\n              ret[key] = self[key];\n            }\n          }\n        });\n\n        return ret;\n      },\n      writable: true,\n      configurable: true\n    },\n    reset: {\n\n\n      /**\n       * Reset all changes made to this doc.\n       *\n       * This will remove newly added properties and revert pre-existing ones \n       * to their original values.\n       */\n      value: function reset() {\n        var self = this;\n\n        Object.keys(this).forEach(function (key) {\n          // if it's an original property\n          if (self.__doc.hasOwnProperty(key)) {\n            delete self.__newDoc[key];\n          } else if (!_.isFunction(self[key])) {\n            // if it's a newly added one\n            delete self[key];\n          }\n        });\n\n        // reset marked properties\n        self.__marked = {};\n      },\n      writable: true,\n      configurable: true\n    },\n    save: {\n\n\n\n      /**\n       * Persist changes made to this document.\n       */\n      value: function* save() {\n        var changes = this.changes();\n\n        yield this.__col.update({\n          _id: this._id }, {\n          $set: changes\n        });\n\n        // reset properties\n        this._resetProperties(this.toJSON());\n      },\n      writable: true,\n      configurable: true\n    },\n    remove: {\n\n\n\n      /**\n       * Remove this document from the collection.\n       */\n      value: function* remove() {\n        yield this.__col.remove({\n          _id: this._id\n        });\n      },\n      writable: true,\n      configurable: true\n    },\n    reload: {\n\n\n\n      /**\n       * Reload this document from the collection.\n       */\n      value: function* reload() {\n        var doc = yield this.__col.findOne({\n          _id: this._id\n        }, {\n          rawMode: true\n        });\n\n        this._resetProperties(doc);\n      },\n      writable: true,\n      configurable: true\n    }\n  });\n\n  return Document;\n})();\n\n\n\n\nDocument.extend = Class.extend;\n\nmodule.exports = Document;"]}