{"version":3,"sources":["readstream.js"],"names":[],"mappings":"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","file":"readstream-compiled.js","sourcesContent":["var Stream = require('stream').Stream,\n  timers = require('timers'),\n  util = require('util');\n\n// Set processor, setImmediate if 0.10 otherwise nextTick\nvar processor = require('../utils').processor();\n\n/**\n * ReadStream\n *\n * Returns a stream interface for the **file**.\n *\n * Events\n *  - **data** {function(item) {}} the data event triggers when a document is ready.\n *  - **end** {function() {}} the end event triggers when there is no more documents available.\n *  - **close** {function() {}} the close event triggers when the stream is closed.\n *  - **error** {function(err) {}} the error event triggers if an error happens.\n *\n * @class Represents a GridFS File Stream.\n * @param {Boolean} autoclose automatically close file when the stream reaches the end.\n * @param {GridStore} cursor a cursor object that the stream wraps.\n * @return {ReadStream}\n */\nfunction ReadStream(autoclose, gstore) {\n  if (!(this instanceof ReadStream)) return new ReadStream(autoclose, gstore);\n  Stream.call(this);\n\n  this.autoclose = !!autoclose;\n  this.gstore = gstore;\n\n  this.finalLength = gstore.length - gstore.position;\n  this.completedLength = 0;\n  this.currentChunkNumber = gstore.currentChunk.chunkNumber;\n\n  this.paused = false;\n  this.readable = true;\n  this.pendingChunk = null;\n  this.executing = false;  \n  this.destroyed = false;\n\n  // Calculate the number of chunks\n  this.numberOfChunks = Math.ceil(gstore.length/gstore.chunkSize);\n\n  // This seek start position inside the current chunk\n  this.seekStartPosition = gstore.position - (this.currentChunkNumber * gstore.chunkSize);\n  \n  var self = this;\n  processor(function() {\n    self._execute();\n  });\n};\n\n/**\n * Inherit from Stream\n * @ignore\n * @api private\n */\nReadStream.prototype.__proto__ = Stream.prototype;\n\n/**\n * Flag stating whether or not this stream is readable.\n */\nReadStream.prototype.readable;\n\n/**\n * Flag stating whether or not this stream is paused.\n */\nReadStream.prototype.paused;\n\n/**\n * @ignore\n * @api private\n */\nReadStream.prototype._execute = function() {\n  if(this.paused === true || this.readable === false) {\n    return;\n  }\n\n  var gstore = this.gstore;\n  var self = this;\n  // Set that we are executing\n  this.executing = true;\n\n  var last = false;\n  var toRead = 0;\n\n  if(gstore.currentChunk.chunkNumber >= (this.numberOfChunks - 1)) {\n    self.executing = false;    \n    last = true;    \n  }\n\n  // Data setup\n  var data = null;\n\n  // Read a slice (with seek set if none)\n  if(this.seekStartPosition > 0 && (gstore.currentChunk.length() - this.seekStartPosition) > 0) {\n    data = gstore.currentChunk.readSlice(gstore.currentChunk.length() - this.seekStartPosition);\n    this.seekStartPosition = 0;\n  } else {\n    data = gstore.currentChunk.readSlice(gstore.currentChunk.length());\n  }\n\n  var processNext = function() {\n    if(last === true) {\n      self.readable = false;\n      self.emit(\"end\");\n      \n      if(self.autoclose === true) {\n        if(gstore.mode[0] == \"w\") {\n          gstore.close(function(err, doc) {\n            if (err) {\n              self.emit(\"error\", err);\n              return;\n            }\n            self.readable = false;  \n            self.destroyed = true;        \n            self.emit(\"close\", doc);\n          });\n        } else {\n          self.readable = false;\n          self.destroyed = true;        \n          self.emit(\"close\");\n        }\n      }\n    } else {\n      gstore._nthChunk(gstore.currentChunk.chunkNumber + 1, function(err, chunk) {\n        if(err) {\n          self.readable = false;\n          if(self.listeners(\"error\").length > 0)\n            self.emit(\"error\", err);\n          self.executing = false;\n          return;\n        }\n\n        self.pendingChunk = chunk;\n        if(self.paused === true) {\n          self.executing = false;\n          return;\n        }\n\n        gstore.currentChunk = self.pendingChunk;\n        self._execute();        \n      });\n    }    \n  }\n\n  // Return the data\n  if(data != null && gstore.currentChunk.chunkNumber == self.currentChunkNumber) {\n    self.currentChunkNumber = self.currentChunkNumber + 1;\n    self.completedLength += data.length;\n    self.pendingChunk = null;\n    // Send the data\n    process.nextTick(function() {\n      self.emit(\"data\", data); \n      processNext();           \n    })\n  } else {\n    processNext();\n  }\n};\n\n/**\n * Pauses this stream, then no farther events will be fired.\n *\n * @ignore\n * @api public\n */\nReadStream.prototype.pause = function() {\n  if(!this.executing) {\n    this.paused = true;    \n  }\n};\n\n/**\n * Destroys the stream, then no farther events will be fired.\n *\n * @ignore\n * @api public\n */\nReadStream.prototype.destroy = function() {\n  if(this.destroyed) return;\n  this.destroyed = true;\n  this.readable = false;\n  // Emit close event\n  this.emit(\"close\");\n};\n\n/**\n * Resumes this stream.\n *\n * @ignore\n * @api public\n */\nReadStream.prototype.resume = function() {\n  if(this.paused === false || !this.readable) {\n    return;\n  }\n    \n  this.paused = false;\n  var self = this;\n  processor(function() {\n    self._execute();\n  });\n};\n\nexports.ReadStream = ReadStream;\n"]}