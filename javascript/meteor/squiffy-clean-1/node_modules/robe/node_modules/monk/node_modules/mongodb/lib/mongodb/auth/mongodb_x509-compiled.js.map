{"version":3,"sources":["mongodb_x509.js"],"names":[],"mappings":"AAAA,IAAI,SAAS,GAAG,OAAO,CAAC,wBAAwB,CAAC,CAAC,SAAS;IACvD,KAAK,GAAG,OAAO,CAAC,UAAU,CAAC;IAC3B,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM;IAC/B,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC;;AAEpC,IAAI,YAAY,GAAG,UAAS,EAAE,EAAE,QAAQ,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE;AACrE,MAAI,mBAAmB,GAAG,CAAC,CAAC;AAC5B,MAAI,WAAW,GAAG,IAAI,CAAC;;AAEvB,MAAG,OAAO,CAAC,YAAY,CAAC,IAAI,IAAI,EAAE;;AAEhC,uBAAmB,GAAG,CAAC,CAAC;GACzB,MAAM;;AAEL,uBAAmB,GAAG,EAAE,CAAC,YAAY,CAAC,iBAAiB,EAAE,CAAC,MAAM,CAAC;AACjE,WAAO,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC;GACzB;;;AAAA,AAGD,MAAI,OAAO,GAAG;AACV,gBAAY,EAAE,CAAC;AACf,aAAS,EAAE,cAAc;AACzB,QAAI,EAAE,QAAQ;GACjB;;;AAAC,AAGF,MAAI,WAAW,GAAG,OAAO,CAAC,YAAY,CAAC,IAAI,IAAI,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,GAAG,EAAE,CAAC,YAAY,CAAC,iBAAiB,EAAE;;;AAAC,AAGhH,OAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,mBAAmB,EAAE,CAAC,EAAE,EAAE;AAC3C,QAAI,UAAU,GAAG,WAAW,CAAC,CAAC,CAAC;;AAAC,AAEhC,MAAE,CAAC,oBAAoB,CAAC,SAAS,CAAC,eAAe,CAAC,EAAE,EAAE,OAAO,EAAE,EAAE,EAAE,WAAW,CAAC,EAAE,EAAC,UAAU,EAAC,UAAU,EAAC,EAAE,UAAS,GAAG,EAAE,MAAM,EAAE;;AAE9H,yBAAmB,GAAG,mBAAmB,GAAG,CAAC;;;AAAC,AAG9C,UAAG,GAAG,EAAE;AACN,mBAAW,GAAG,GAAG,CAAC;OACnB,MAAM,IAAG,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI,IAAI,IAAI,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,MAAM,IAAI,IAAI,EAAC;AAC9E,mBAAW,GAAG,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;OAClD;;;AAAA,AAGD,UAAG,mBAAmB,IAAI,CAAC,IAAI,OAAO,QAAQ,IAAI,UAAU,EAAE;AAC5D,YAAI,gBAAgB,GAAG,QAAQ,CAAC;AAChC,gBAAQ,GAAG,IAAI,CAAC;;AAEhB,YAAG,WAAW,IAAI,IAAI,IAAI,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,EAAE;;AAErD,YAAE,CAAC,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,cAAc,EAAE,EAAE,CAAC,YAAY,EAAE,QAAQ,EAAE,QAAQ,CAAC;;AAAC,AAE9E,0BAAgB,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;SACrC,MAAM;AACL,0BAAgB,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;SACtC;OACF;KACF,CAAC,CAAC;GACJ;CACF,CAAA;;AAED,OAAO,CAAC,YAAY,GAAG,YAAY,CAAC","file":"mongodb_x509-compiled.js","sourcesContent":["var DbCommand = require('../commands/db_command').DbCommand\n  , utils = require('../utils')\n  , Binary = require('bson').Binary\n  , format = require('util').format;\n\nvar authenticate = function(db, username, password, options, callback) {\n  var numberOfConnections = 0;\n  var errorObject = null;\n  \n  if(options['connection'] != null) {\n    //if a connection was explicitly passed on options, then we have only one...\n    numberOfConnections = 1;\n  } else {\n    // Get the amount of connections in the pool to ensure we have authenticated all comments\n    numberOfConnections = db.serverConfig.allRawConnections().length;\n    options['onAll'] = true;\n  }\n\n  // Let's start the sasl process\n  var command = {\n      authenticate: 1\n    , mechanism: 'MONGODB-X509'\n    , user: username\n  };\n\n  // Grab all the connections\n  var connections = options['connection'] != null ? [options['connection']] : db.serverConfig.allRawConnections();\n\n  // Authenticate all connections\n  for(var i = 0; i < numberOfConnections; i++) {\n    var connection = connections[i];\n    // Execute first sasl step\n    db._executeQueryCommand(DbCommand.createDbCommand(db, command, {}, '$external'), {connection:connection}, function(err, result) {\n      // Count down\n      numberOfConnections = numberOfConnections - 1;\n\n      // Ensure we save any error\n      if(err) {\n        errorObject = err;\n      } else if(result.documents[0].err != null || result.documents[0].errmsg != null){\n        errorObject = utils.toError(result.documents[0]);\n      }\n\n      // Work around the case where the number of connections are 0\n      if(numberOfConnections <= 0 && typeof callback == 'function') {\n        var internalCallback = callback;\n        callback = null;\n\n        if(errorObject == null && result.documents[0].ok == 1) {\n          // We authenticated correctly save the credentials\n          db.serverConfig.auth.add('MONGODB-X509', db.databaseName, username, password);\n          // Return callback\n          internalCallback(errorObject, true);\n        } else {\n          internalCallback(errorObject, false);\n        }\n      }\n    });\n  }\n}\n\nexports.authenticate = authenticate;"]}