{"version":3,"sources":["scope.js"],"names":[],"mappings":"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","file":"scope-compiled.js","sourcesContent":["var Cursor2 = require('./cursor').Cursor\n  , Readable = require('stream').Readable\n  , utils = require('./utils')\n  , inherits = require('util').inherits;\n\nvar Cursor = function Cursor(_scope_options, _cursor) {\n  //\n  // Backward compatible methods\n  this.toArray = function(callback) {\n    return _cursor.toArray(callback);\n  }\n\n  this.each = function(callback) {\n    return _cursor.each(callback);\n  }\n\n  this.next = function(callback) {\n    this.nextObject(callback);\n  }\n\n  this.nextObject = function(callback) {\n    return _cursor.nextObject(callback);\n  }\n\n  this.setReadPreference = function(readPreference, callback) {\n    _scope_options.readPreference = {readPreference: readPreference};\n    _cursor.setReadPreference(readPreference, callback);\n    return this;\n  }\n\n  this.batchSize = function(batchSize, callback) {\n    _scope_options.batchSize = batchSize;\n    _cursor.batchSize(_scope_options.batchSize, callback);\n    return this;\n  }\n\n  this.count = function(applySkipLimit, callback) {\n    return _cursor.count(applySkipLimit, callback);\n  }\n\n  this.stream = function(options) {\n    return _cursor.stream(options);\n  }\n\n  this.close = function(callback) {\n    return _cursor.close(callback);\n  }\n\n  this.explain = function(callback) {\n    return _cursor.explain(callback);\n  }\n\n  this.isClosed = function(callback) {\n    return _cursor.isClosed();\n  }\n\n  this.rewind = function() {\n    return _cursor.rewind();\n  }\n\n  // Internal methods\n  this.limit = function(limit, callback) {\n    _cursor.limit(limit, callback);\n    _scope_options.limit = limit;\n    return this;\n  }\n\n  this.skip = function(skip, callback) {\n    _cursor.skip(skip, callback);\n    _scope_options.skip = skip;\n    return this;\n  }\n\n  this.hint = function(hint) {\n    _scope_options.hint = hint;\n    _cursor.hint = _scope_options.hint;\n    return this;\n  }\n\n  this.maxTimeMS = function(maxTimeMS) {  \n    _cursor.maxTimeMS(maxTimeMS)\n    _scope_options.maxTimeMS = maxTimeMS;\n    return this;\n  },  \n\n  this.sort = function(keyOrList, direction, callback) {\n    _cursor.sort(keyOrList, direction, callback);\n    _scope_options.sort = keyOrList;\n    return this;\n  },\n\n  this.fields = function(fields) {\n    _fields = fields;\n    _cursor.fields = _fields;\n    return this;\n  }\n\n  //\n  // Backward compatible settings\n  Object.defineProperty(this, \"timeout\", {\n    get: function() {\n      return _cursor.timeout;\n    }\n  });\n\n  Object.defineProperty(this, \"items\", {\n    get: function() {\n      return _cursor.items;\n    }\n  });  \n\n  Object.defineProperty(this, \"readPreference\", {\n    get: function() {\n      return _cursor.readPreference;\n    }\n  });  \n}\n\nvar Scope = function(collection, _selector, _fields, _scope_options) {\n  var self = this;\n\n  // Ensure we have at least an empty cursor options object\n  _scope_options = _scope_options || {};\n  var _write_concern = _scope_options.write_concern || null;\n\n  // Ensure default read preference\n  // if(!_scope_options.readPreference) _scope_options.readPreference = 'primary';\n\n  // Set up the cursor\n  var _cursor = new Cursor2(\n        collection.db, collection, _selector\n      , _fields, _scope_options\n    );\n\n  // Write branch options\n  var writeOptions = {\n    insert: function(documents, callback) {\n      // Merge together options\n      var options = _write_concern || {};\n      // Execute insert\n      collection.insert(documents, options, callback);\n    },\n    \n    save: function(document, callback) {\n      // Merge together options\n      var save_options = _write_concern || {};\n      // Execute save\n      collection.save(document, save_options, function(err, result) {\n        if(typeof result == 'number' && result == 1) {\n          return callback(null, document);\n        }\n\n        return callback(null, document);\n      });\n    },\n\n    find: function(selector) {\n      _selector = selector;\n      return writeOptions;\n    },\n\n    //\n    // Update is implicit multiple document update\n    update: function(operations, callback) {\n      // Merge together options\n      var update_options = _write_concern || {};\n      \n      // Set up options, multi is default operation\n      update_options.multi = _scope_options.multi ? _scope_options.multi : true;\n      if(_scope_options.upsert) update_options.upsert = _scope_options.upsert;\n      \n      // Execute options\n      collection.update(_selector, operations, update_options, function(err, result, obj) {\n        callback(err, obj);\n      });\n    },\n  }\n\n  // Set write concern\n  this.withWriteConcern = function(write_concern) {\n    // Save the current write concern to the Scope\n    _scope_options.write_concern = write_concern;\n    _write_concern = write_concern;\n    // Only allow legal options\n    return writeOptions;\n  }\n\n  // Start find\n  this.find = function(selector, options) {\n    // Save the current selector\n    _selector = selector;\n    // Set the cursor\n    _cursor.selector = selector;\n    // Return only legal read options\n    return new Cursor(_scope_options, _cursor);\n  }\n}\n\nexports.Scope = Scope;\n"]}