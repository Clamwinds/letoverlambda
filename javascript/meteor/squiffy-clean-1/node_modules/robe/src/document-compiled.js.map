{"version":3,"sources":["document.js"],"names":[],"mappings":"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","file":"document-compiled.js","sourcesContent":["\"use strict\";\n\n\nvar _ = require('lodash'),\n  Class = require('class-extend'),\n  Q = require('bluebird')\n\n\n\n/**\n * Represents a document within a collection.\n */\nclass Document {\n  /**\n   * Constructor.\n   *\n   * @param  {Collection} collection The underlying collection.\n   * @param  {Object} [doc] The Mongo record document.\n   */\n  constructor (collection, doc = {}) {\n    var self = this;\n\n    Object.defineProperties(this, {\n      __col: {\n        enumerable: false,\n        writable: false,\n        value: collection\n      },\n      __newDoc: {\n        enumerable: false,\n        writable: true,\n        value: {}\n      },\n      __marked: {\n        enumerable: false,\n        writable: true,\n        value: {}\n      },\n      // can store any extra data that's not intended for persistence in this field\n      __extra: {\n        enumerable: false,\n        writable: true,\n        value: {}\n      },\n    });\n\n    this._resetProperties(doc);\n  }\n\n  /**\n   * Reset original properties to given doc.\n   * @private\n   */\n  _resetProperties (doc) {\n    var self = this;\n\n    Object.defineProperty(self, '__doc', {\n      enumerable: false,\n      writable: true,\n      value: doc\n    });\n\n    self.__newDoc = {};\n    self.__marked = {};\n\n    for (let key in self.__doc) {\n      // if property not yet defined\n      if (!Object.getOwnPropertyDescriptor(self, key)) {\n        // ...then define it!\n        Object.defineProperty(self, key, {\n          enumerable: true,\n          configurable: true,\n          get: function() {\n            return _.has(self.__newDoc, key) ? self.__newDoc[key] : self.__doc[key];\n          },\n          set: function(val) {\n            self.__newDoc[key] = val;\n          }\n        });\n      }\n    }\n\n    // delete any extraneous properties\n    Object.keys(this).forEach(function(key) {\n      if (!_.isFunction(self[key]) && !self.__doc.hasOwnProperty(key)) {\n        delete self[key];\n      }\n    });\n  }\n\n\n  /**\n   * Mark a property as having changed.\n   *\n   * This is useful if you a change a value within a non-scalar (e.g. `object`) \n   * property or an array.\n   * \n   * @param  {Array} ...keys Properties to mark as having changed.\n   * @return {[type]}     [description]\n   */\n  markChanged (...keys) {\n    for (let k in keys) {\n      this.__marked[keys[k]] = true;\n    }\n  }\n\n\n\n  toJSON () {\n    var self = this;\n\n    var ret = {};\n\n    Object.keys(this).forEach(function(key) {\n      if (!_.isFunction(self[key])) {\n        ret[key] = self[key]\n      }\n    });\n\n    return ret;\n  }\n\n\n  /**\n   * Get changed properties.\n   * @return {Object}\n   */\n  changes () {\n    var self = this;\n\n    var ret = {};\n\n    Object.keys(this).forEach(function(key) {\n      if (!_.isFunction(self[key])) {\n        if ( (self.__doc[key] !== self[key]) \n                || self.__marked[key] ) {\n          ret[key] = self[key];\n        }\n      }\n    });\n\n    return ret;\n  }\n\n\n  /**\n   * Reset all changes made to this doc.\n   *\n   * This will remove newly added properties and revert pre-existing ones \n   * to their original values.\n   */\n  reset () {\n    var self = this;\n\n    Object.keys(this).forEach(function(key) {\n      // if it's an original property\n      if (self.__doc.hasOwnProperty(key)) {\n        delete self.__newDoc[key];\n      }\n      else if (!_.isFunction(self[key])) {\n        // if it's a newly added one\n        delete self[key];\n      }\n    });\n\n    // reset marked properties\n    self.__marked = {};\n  }\n\n\n\n  /**\n   * Persist changes made to this document.\n   */\n  * save () {\n    var changes = this.changes();\n\n    yield this.__col.update({\n      _id: this._id,\n    }, {\n      $set: changes\n    });\n\n    // reset properties\n    this._resetProperties(this.toJSON());\n  }\n\n\n\n  /**\n   * Remove this document from the collection.\n   */\n  * remove () {\n    yield this.__col.remove({\n      _id: this._id\n    });\n  }\n\n\n\n  /**\n   * Reload this document from the collection.\n   */\n  * reload () {\n    var doc = yield this.__col.findOne({\n      _id: this._id\n    }, {\n      rawMode: true\n    });\n\n    this._resetProperties(doc);\n  }\n}\n\n\nDocument.extend = Class.extend;\n\nmodule.exports = Document;\n\n\n"]}